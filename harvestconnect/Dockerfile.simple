# Base Node.js image\nFROM node:20-alpine AS base\n\nWORKDIR /app\n\n# Install production dependencies\nCOPY package*.json ./\nRUN npm ci --only=production --verbose\n\n# Build stage\nFROM node:20-alpine AS builder\n\nWORKDIR /app\n\n# Install all dependencies for building\nCOPY package*.json ./\nRUN npm ci --verbose\n\n# Copy source code\nCOPY next.config.js ./\nCOPY tsconfig.json ./\nCOPY public ./public\nCOPY app ./app\nCOPY components ./components\nCOPY lib ./lib\n\n# Build the application\nRUN npm run build\n\n# Production stage\nFROM node:20-alpine AS runner\n\nWORKDIR /app\n\n# Set production environment\nENV NODE_ENV=production\nENV HOST=0.0.0.0\nENV PORT=3000\n\n# Copy package.json and production dependencies from base\nCOPY package*.json ./\nCOPY --from=base /app/node_modules ./node_modules\n\n# Copy built application\nCOPY --from=builder /app/.next ./.next\nCOPY --from=builder /app/public ./public\n\n# Create non-root user\nRUN addgroup -g 1001 -S nodejs && \\\n    adduser -S nextjs -u 1001 -G nodejs\n\nUSER nextjs\n\n# Expose port\nEXPOSE 3000\n\n# Start the application\nCMD [\"npm\", \"start\"]\n