services:
  backend:
    build:
      context: ./backend
      target: production
    environment:
      # Django Configuration
      - ADMIN_URL_PATH=${ADMIN_URL_PATH:-/admin}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS:-*}
      - CSRF_TRUSTED_ORIGINS=${CSRF_TRUSTED_ORIGINS:-https://*.koyeb.app}
      - DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY}
      - DEBUG=${DEBUG:-False}
      
      # Database Configuration - PostgreSQL with Neon as primary
      - DATABASE_URL=${POSTGRES_URL:-${DATABASE_URL}}
      
      # GitHub Integration
      - BBGITHUB_OAUTH2_CLIENT_SECRET=${BBGITHUB_OAUTH2_CLIENT_SECRET}
      - BBGITHUB_TOKEN=${BBGITHUB_TOKEN}
      
      # Security & Testing
      - CODECOV_TOKEN=${CODECOV_TOKEN}
      - SNYK_TOKEN=${SNYK_TOKEN}
      
      # Cloud Services
      - GOOGLE_GEMINI_API_KEY=${GOOGLE_GEMINI_API_KEY}
      - GOOGLE_OAUTH2_CLIENT_ID=${GOOGLE_OAUTH2_CLIENT_ID}
      - GOOGLE_OAUTH2_CLIENT_SECRET=${GOOGLE_OAUTH2_CLIENT_SECRET}
      - KOYEB_TOKEN=${KOYEB_TOKEN}
      - NETLIFY_AUTH_TOKEN=${NETLIFY_AUTH_TOKEN}
      - NETLIFY_SITE_ID=${NETLIFY_SITE_ID}
      - SUPABASE_S3_ACCESS_KEY_ID=${SUPABASE_S3_ACCESS_KEY_ID}
      - SUPABASE_S3_ENDPOINT_URL=${SUPABASE_S3_ENDPOINT_URL}
      - SUPABASE_S3_SECRET_ACCESS_KEY=${SUPABASE_S3_SECRET_ACCESS_KEY}
      
      # Redis Configuration (Upstash)
      - REDIS_URL=${REDIS_URL}
      
      # Additional Django settings
      - SECRET_KEY=${DJANGO_SECRET_KEY}
      - SOCIAL_AUTH_GOOGLE_OAUTH2_KEY=${SOCIAL_AUTH_GOOGLE_OAUTH2_KEY}
      - SOCIAL_AUTH_GOOGLE_OAUTH2_SECRET=${SOCIAL_AUTH_GOOGLE_OAUTH2_SECRET}
      - EMAIL_HOST=${EMAIL_HOST}
      - EMAIL_PORT=${EMAIL_PORT:-587}
      - EMAIL_HOST_USER=${EMAIL_HOST_USER}
      - EMAIL_HOST_PASSWORD=${EMAIL_HOST_PASSWORD}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
    env_file:
      - ./.env
    command: >
      bash -c "
        python manage.py collectstatic --noinput &&
        python manage.py migrate &&
        gunicorn --bind 0.0.0.0:8000 harvestconnect.wsgi:application
      "
    networks:
      - app-network

  frontend:
    build:
      context: ./harvestconnect
      target: runner
    environment:
      # Frontend Configuration
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-https://harvestconnect-backend-koyeb.app/api}
      - NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=${NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY}
      - PRODUCTION_URL=${PRODUCTION_URL}
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      
      # Cloud Services
      - GOOGLE_GEMINI_API_KEY=${GOOGLE_GEMINI_API_KEY}
      - GOOGLE_OAUTH2_CLIENT_ID=${GOOGLE_OAUTH2_CLIENT_ID}
      
      # General settings
      - NODE_ENV=production
      - PORT=3000
    networks:
      - app-network
    command: ["npm", "start"]

networks:
  app-network:
    driver: bridge